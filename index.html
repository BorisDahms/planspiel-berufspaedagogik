<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Planspiel: PlanA GmbH - Bildungscampus Leipzig</title>
    <style>
        /* --- GRUNDLEGENDES DESIGN --- */
        *, *::before, *::after { box-sizing: border-box; }

        :root {
            --bg-color: #2b2e4a;
            --text-color: #ffffff;
            --accent: #e84545; /* Rot f√ºr PlanA / Chef */
            --panel-bg: rgba(30, 30, 40, 0.96);
            --success: #2ecc71;
            --gold: #f1c40f;
            --error: #c0392b;
            --ai-color: #9b59b6; 
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            color: var(--text-color);
            margin: 0;
            height: 100vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        /* HEADER */
        header {
            background-color: rgba(0,0,0,0.95);
            padding: 10px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center; 
            border-bottom: 3px solid var(--accent);
            height: 80px; 
            flex-shrink: 0;
            box-shadow: 0 5px 20px rgba(0,0,0,0.6);
            z-index: 50;
        }

        .header-left { display: flex; align-items: center; }
        .bc-logo { height: 55px; background: rgba(255,255,255,0.95); padding: 5px; border-radius: 4px; margin-right: 20px; }
        .title-group { display: flex; flex-direction: column; }
        .main-title { font-weight: bold; font-size: 1.6rem; color: #ffffff; letter-spacing: 0.5px; text-shadow: 0 2px 4px rgba(0,0,0,0.5); }
        .sub-title { font-size: 1rem; color: #bbb; letter-spacing: 1px; margin-top: 3px; font-weight: 300; }
        
        /* KPI BARS */
        .kpi-container { display: flex; gap: 20px; align-items: flex-start; }
        .kpi-box { text-align: center; width: 120px; position: relative; }
        .kpi-label { font-size: 0.7rem; color: #aaa; display: block; margin-bottom: 3px; }
        .progress-bg { background: #333; height: 10px; border-radius: 5px; overflow: hidden; border: 1px solid #444; }
        .progress-fill { height: 100%; transition: width 0.6s cubic-bezier(0.4, 0, 0.2, 1); }
        .impressum-link { display: block; margin-top: 5px; font-size: 0.7rem; color: #888; text-decoration: underline; cursor: pointer; transition: color 0.2s; }
        .impressum-link:hover { color: var(--gold); }

        /* STAGE LAYOUT */
        .stage {
            flex: 1; display: grid; grid-template-columns: 350px 1fr; gap: 20px; padding: 20px 40px; max-width: 1400px;
            margin: 0 auto; width: 100%; position: relative; overflow: hidden; 
        }

        /* LINKE SPALTE */
        .char-column { 
            display: flex; flex-direction: column; justify-content: flex-start; align-items: center; 
            height: 100%; position: relative; max-width: 100%; 
        }
        
        .privacy-hint-sidebar {
            font-size: 0.7rem; color: #aaa; margin-bottom: 10px; display: flex; align-items: flex-start; gap: 8px; line-height: 1.3;
            background: rgba(0,0,0,0.3); padding: 10px; border-radius: 6px; width: 100%; border-left: 2px solid #888;
        }

        .undo-btn {
            background: #444; border: 1px solid #666; color: white; padding: 8px 15px; border-radius: 4px; cursor: pointer; font-size: 0.9rem;
            display: flex; align-items: center; justify-content: center; gap: 5px; transition: 0.2s; width: 100%; margin-bottom: 10px;
        }
        .undo-btn:hover { background: #666; border-color: #888; }
        .undo-btn:disabled { opacity: 0.3; cursor: not-allowed; }

        .name-input-group { width: 100%; margin-bottom: 20px; text-align: left; display: none; }
        .name-label { font-size: 0.8rem; color: var(--gold); margin-bottom: 4px; display: block; line-height: 1.3; }
        .name-input {
            width: 100%; background: rgba(0,0,0,0.3); border: 1px solid #555; color: #fff; padding: 10px; border-radius: 4px;
            font-family: inherit; font-size: 1rem; transition: 0.2s; font-style: italic;
        }
        .name-input:focus { outline: none; border-color: var(--gold); background: rgba(0,0,0,0.5); }

        .char-img-container {
            width: 100%; height: 260px; display: flex; align-items: flex-end; justify-content: center;
            background: radial-gradient(circle at bottom, rgba(232, 69, 69, 0.15) 0%, transparent 70%); 
            margin-bottom: 0; transition: background 0.5s ease;
        }
        .char-img-container.klara-mode {
            background: radial-gradient(circle at bottom, rgba(155, 89, 182, 0.25) 0%, transparent 70%) !important;
        }
        .char-img { max-width: 100%; max-height: 100%; filter: drop-shadow(0 0 15px rgba(0,0,0,0.7)); transition: transform 0.3s ease-out; }
        
        .char-name-badge {
            background: var(--accent); color: white; padding: 8px 20px; border-radius: 20px; font-weight: bold; z-index: 10;
            font-size: 1.1rem; box-shadow: 0 4px 10px rgba(0,0,0,0.5); border: 1px solid rgba(255,255,255,0.2);
            margin-top: -25px; margin-bottom: 15px; position: relative; transition: background 0.5s;
        }
        .char-name-badge.klara-mode { background: var(--ai-color); }

        /* Container unter dem Bild (Links) */
        .char-extra-box {
            width: 100%; min-height: 100px; background: rgba(0,0,0,0.4); border: 1px solid #555; border-radius: 12px; padding: 20px; 
            backdrop-filter: blur(5px); display: flex; flex-direction: column; justify-content: center; align-items: center;
            text-align: left; animation: slideUp 0.8s ease-out;
        }
        .role-text { font-size: 0.95rem; line-height: 1.5; color: #ddd; }
        
        /* SPEZIELLER STYLE F√úR 'IHRE ROLLE' BOX (LINKS) */
        .role-box-left {
            width: 100%;
            background: #1a1a2e; /* Dunkler Hintergrund wie im Bild */
            border: 1px solid #444;
            border-radius: 8px;
            padding: 15px;
            text-align: left;
            box-shadow: 0 4px 10px rgba(0,0,0,0.5);
        }
        .role-title {
            color: #f1c40f; /* Gelb */
            font-weight: bold;
            text-transform: uppercase;
            font-size: 0.8rem;
            letter-spacing: 1px;
            margin-bottom: 10px;
            display: block;
        }
        .role-description {
            font-size: 0.9rem;
            color: #ccc;
            margin-bottom: 15px;
            line-height: 1.4;
        }

        /* RECHTE SPALTE */
        .dialog-column { display: flex; flex-direction: column; gap: 20px; overflow-y: auto; padding-right: 10px; max-height: 88vh; }
        
        .dialog-box {
            background: var(--panel-bg); border: 1px solid #444; border-radius: 12px; padding: 35px;
            box-shadow: 0 15px 40px rgba(0,0,0,0.6); position: relative; backdrop-filter: blur(5px);
        }
        .dialog-box h2 { margin-top: 0; color: var(--accent); font-size: 2rem; margin-bottom: 15px; }
        
        /* INHALT RECHTS (PlanA Infos) */
        .intro-title { color: #e84545; font-size: 2.2rem; font-weight: bold; margin-bottom: 20px; }
        .product-list { margin: 15px 0; line-height: 1.6; padding-left: 5px; }
        .product-list b { color: #fff; }

        .team-grid {
            display: grid; grid-template-columns: 260px 1fr;
            gap: 8px;
            background: rgba(0,0,0,0.3); padding: 15px; border-radius: 8px; border-left: 3px solid #e84545;
            margin-top: 20px; margin-bottom: 20px; font-size: 0.95rem;
        }
        .team-role { color: #f1c40f; font-weight: bold; }
        .team-name { color: #ffffff; }

        /* BUTTONS */
        .actions-container { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 15px; padding-bottom: 20px; }
        
        button.choice-btn {
            background: linear-gradient(180deg, #2d3436 0%, #1a1a1a 100%); border: 1px solid #555; color: white; padding: 18px 25px;
            border-radius: 8px; font-size: 1.1rem; cursor: pointer; transition: all 0.2s ease; text-align: left;
            position: relative; overflow: hidden; box-shadow: 0 4px 0 #000; width: 100%;
        }
        button.choice-btn:hover { border-color: var(--accent); transform: translateY(-2px); box-shadow: 0 6px 0 #000; }
        
        /* Start Button (Gr√ºn) */
        button.start-btn-green {
            background: linear-gradient(180deg, #27ae60 0%, #219150 100%); border: 1px solid #2ecc71;
            color: white; font-size: 1.1rem; font-weight: bold; padding: 12px; width: 100%;
            border-radius: 6px; cursor: pointer; box-shadow: 0 4px 0 #1e8449; transition: transform 0.1s; text-align: center;
        }
        button.start-btn-green:hover { transform: translateY(-2px); box-shadow: 0 6px 0 #1e8449; }
        button.start-btn-green:active { transform: translateY(2px); box-shadow: 0 2px 0 #1e8449; }

        /* ANIMATIONEN */
        .fade-in-effect { animation: fadeIn 0.5s ease-out forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes slideUp { from { transform: translateY(50px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

        /* OVERLAYS */
        .overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.92); z-index: 100;
            display: flex; flex-direction: column; align-items: center; justify-content: center; backdrop-filter: blur(5px);
        }
        .hidden { display: none !important; }
        .overlay-card {
            background: #222; border: 2px solid var(--accent); padding: 40px; border-radius: 12px;
            max-width: 1000px; width: 95%; text-align: center; box-shadow: 0 0 30px rgba(232, 69, 69, 0.2);
            max-height: 95vh; overflow-y: auto;
            position: relative; /* F√ºr den Debug Button */
        }

        /* AI & QUIZ STYLES */
        .ai-input-area { width: 100%; min-height: 120px; background: #1a1a2e; border: 2px solid var(--ai-color); color: #fff; padding: 15px; font-size: 1.1rem; border-radius: 8px; margin-bottom: 15px; }
        .ai-feedback-box { background: rgba(155, 89, 182, 0.1); border-left: 4px solid var(--ai-color); padding: 15px; text-align: left; margin-top: 15px; border-radius: 4px; display: none; }
        .ai-score-bar { height: 8px; background: #333; width: 100%; border-radius: 4px; margin-top: 10px; overflow: hidden; }
        .ai-score-fill { height: 100%; width: 0%; background: var(--ai-color); transition: width 1s ease-out; }
        
        #quiz-questions-container { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; text-align: left; margin-bottom: 20px; }
        .quiz-option { display: block; text-align: left; background: #333; padding: 12px; margin: 5px 0; border-radius: 5px; cursor: pointer; border: 1px solid #555; transition: 0.2s; }
        .quiz-option:hover { background: #444; }
        .law-text { background: #111; padding: 15px; border-left: 4px solid #f1c40f; text-align: left; margin-bottom: 20px; color: #ccc; }

        .certificate-container { border: 10px solid var(--gold); padding: 40px; background: #fff; color: #222; width: 80%; max-width: 700px; text-align: center; box-shadow: 0 0 50px rgba(241, 196, 15, 0.5); animation: popIn 0.8s ease-out; }
        @keyframes popIn { 0% { transform: scale(0.5); opacity: 0; } 100% { transform: scale(1); opacity: 1; } }
        .watermark { position: fixed; bottom: 20px; right: 30px; opacity: 0.1; font-size: 3rem; font-weight: bold; pointer-events: none; color: white; z-index: 0; }
        
        /* SKIP BUTTON STYLE */
        .debug-skip-btn {
            position: absolute; top: 10px; right: 10px; 
            background: transparent; border: 1px solid #444; color: #666; 
            font-size: 0.8rem; padding: 2px 6px; cursor: pointer; opacity: 0.3; transition: 0.2s;
            border-radius: 4px; z-index: 10;
        }
        .debug-skip-btn:hover { opacity: 1; color: white; border-color: white; }

        /* KREUZWORTR√ÑTSEL STYLES */
        .crossword-grid { display: grid; gap: 2px; justify-content: center; margin: 20px auto; background: #444; padding: 5px; border-radius: 4px; }
        .cw-cell { width: 35px; height: 35px; background: #222; border: none; color: white; text-align: center; font-size: 1.2rem; text-transform: uppercase; font-weight: bold; }
        .cw-cell:focus { background: #444; outline: 1px solid var(--gold); }
        .cw-cell.black { background: #000; pointer-events: none; }
        .cw-clues { text-align: left; font-size: 0.9rem; margin-top: 15px; display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }

        /* DRUCK-STYLES */
        @media print {
            body { background: #fff !important; color: #000 !important; height: auto !important; overflow: visible !important; }
            header, .stage, .watermark { display: none !important; }
            .overlay { position: static !important; background: #fff !important; width: 100% !important; height: auto !important; backdrop-filter: none !important; display: block !important; }
            .overlay-card { border: none !important; box-shadow: none !important; background: #fff !important; color: #000 !important; max-width: 100% !important; padding: 0 !important; text-align: left !important; }
            button { display: none !important; }
            .ai-input-area { border: 1px solid #ccc !important; color: #000 !important; background: #fff !important; }
            h2, h3, strong, p { color: #000 !important; }
            .ai-feedback-box { border-left: 4px solid #000 !important; background: #f0f0f0 !important; color: #000 !important; }
            .overlay.hidden { display: none !important; }
            /* Debug Button beim Drucken ausblenden */
            .debug-skip-btn { display: none !important; }
        }

        @media (max-width: 900px) {
            body { height: auto; overflow-y: auto; }
            header { flex-direction: column; height: auto; gap: 15px; padding: 15px; }
            .stage { display: flex; flex-direction: column; height: auto; padding: 15px; }
            .char-column { width: 100%; height: auto; margin-bottom: 30px; }
            .actions-container { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>

<div class="watermark">¬© Bildungscampus Leipzig</div>

<header>
    <div class="header-left">
        <img src="https://www.bildungscampus-leipzig.de/Bueromanagement/userfiles/images/tcmlogo_blau_gif.gif" alt="Bildungscampus Leipzig" class="bc-logo">
        <div class="title-group">
            <div class="main-title">Bildungscampus Leipzig</div>
            <div class="sub-title"><b>Planspiel - Unternehmenssimulation (DQR 7)</b></div>
        </div>
    </div>

    <div class="kpi-container">
        <div class="kpi-box">
            <span class="kpi-label">‚è≥ Zeitfenster</span>
            <div class="progress-bg"><div id="bar-time" class="progress-fill" style="width: 100%; background: #3498db;"></div></div>
        </div>
        <div class="kpi-box">
            <span class="kpi-label">üí∞ Budget</span>
            <div class="progress-bg"><div id="bar-budget" class="progress-fill" style="width: 100%; background: #2ecc71;"></div></div>
        </div>
        <div class="kpi-box">
            <span class="kpi-label">‚öñÔ∏è Recht/Team</span>
            <div class="progress-bg"><div id="bar-mood" class="progress-fill" style="width: 100%; background: #f1c40f;"></div></div>
            <span class="impressum-link" onclick="openImpressum()">Impressum</span>
        </div>
    </div>
</header>

<div class="stage" id="game-stage">
    <div class="char-column">
        <div class="privacy-hint-sidebar">
            <span style="font-size: 1.2rem;">üîí</span> 
            <div>Datenschutz-Hinweis:<br>Die Datenverarbeitung erfolgt ausschlie√ülich lokal in Ihrem Browser.
Es werden keine Daten auf dem Server gespeichert. </div>
        </div>

        <button class="undo-btn" id="undo-btn" onclick="undoMove()" disabled>‚Ü© Schritt zur√ºck</button>

        <div class="name-input-group" id="name-input-group">
            <label class="name-label">Bitte geben Sie f√ºr Ihre Arbeit einen Namen an:</label>
            <input type="text" id="player-name" class="name-input" placeholder="Ihr Name...">
        </div>

        <div id="char-bg" class="char-img-container">
            <img id="char-image" src="" alt="Charakter" class="char-img" onerror="this.style.display='none'; document.getElementById('char-fallback').style.display='block';">
            <div id="char-fallback" style="font-size: 150px; display:none;">üë®‚Äçüíº</div>
        </div>
        
        <div class="char-name-badge" id="char-name">Dr. Peter Planer</div>
        
        <div id="char-extra" class="char-extra-box" style="display:none; background:transparent; border:none; padding:0; backdrop-filter:none;"></div>
    </div>

    <div class="dialog-column">
        <div class="dialog-box">
            <h2 id="scene-title">Laden...</h2>
            <div id="scene-text" class="dialog-content"></div>
            <div class="side-info" id="scene-info"></div>
        </div>

        <div class="actions-container" id="actions"></div>
    </div>
</div>

<div id="overlay-ai" class="overlay hidden">
    <div class="overlay-card">
        <button class="debug-skip-btn" onclick="debugSkip()" title="Aufgabe √ºberspringen (Debug)">‚è≠Ô∏è</button>
        
        <h2 style="color: var(--ai-color);">Dr. Klara Kompetenz bittet um Ausarbeitung</h2>
        <h3 id="ai-topic" style="color: white; margin: 0; font-weight: 300;"></h3>
        <p id="ai-intro" style="color: #aaa; font-size: 0.95rem; margin: 10px 0 20px; text-align: left; line-height:1.5;">
            </p>
        <textarea id="ai-input" class="ai-input-area" placeholder="Formulieren Sie Ihre Strategie auf Master-Niveau..."></textarea>
        <div style="display:flex; gap:15px; justify-content:center;">
            <button class="choice-btn" style="background:var(--ai-color);" onclick="analyzeAIAnswer()">ü§ñ Konzept einreichen</button>
            <button class="choice-btn" style="background:#444;" onclick="copyAiText()">üìã Text kopieren</button>
        </div>
        <div id="ai-result-box" class="ai-feedback-box">
            <strong id="ai-verdict" style="font-size: 1.2rem;"></strong>
            <div class="ai-score-bar"><div id="ai-score-fill" class="ai-score-fill"></div></div>
            <p id="ai-feedback-text" style="color: #ddd; margin-top:10px;"></p>
            <div style="display:flex; gap:10px; margin-top:20px; justify-content:center; flex-wrap:wrap;">
                <button id="btn-ai-continue" class="choice-btn hidden" style="background: #2ecc71;" onclick="closeAiOverlay()">Weiter</button>
                
                <button id="btn-ai-retry" class="choice-btn hidden" style="background: #e67e22;" onclick="resetAiInput()">Nochmal versuchen</button>
                <button id="btn-ai-skip" class="choice-btn hidden" style="background: #7f8c8d; font-size:0.9rem;" onclick="skipAiTask()">Weiter (Aufgabe nicht bestanden)</button>
                
                <button id="btn-ai-print" class="choice-btn hidden" style="background: #34495e; border: 1px solid #7f8c8d;" onclick="printOverlay()">üñ®Ô∏è Ergebnis drucken</button>
                <button id="btn-ai-giveup" class="choice-btn" style="background: #c0392b; font-size:0.9rem;" onclick="giveUp()">üè≥Ô∏è Ich gebe auf</button>
            </div>
        </div>
    </div>
</div>

<div id="overlay-quiz" class="overlay hidden">
    <div class="overlay-card">
        <button class="debug-skip-btn" onclick="debugSkip()" title="Aufgabe √ºberspringen (Debug)">‚è≠Ô∏è</button>

        <h2 style="color: var(--gold);">Rechtliche Pr√ºfung</h2>
        <h3 id="quiz-topic" style="color: white; margin: 0; font-weight: 300;"></h3>
        <p id="quiz-intro" style="color: #aaa; font-size: 0.95rem; margin: 10px 0 20px; text-align: left; line-height:1.5;"></p>
        <div id="quiz-law-text" class="law-text hidden"></div>
        <div id="quiz-questions-container"></div>
        <div id="quiz-feedback" style="margin:10px; font-weight:bold; font-size:1.2rem;"></div>
        <div style="display:flex; gap:15px; justify-content:center; flex-wrap:wrap;">
            <button class="choice-btn" style="max-width:300px;" onclick="checkQuiz()">L√∂sung pr√ºfen</button>
            <button id="btn-quiz-print" class="choice-btn" style="background: #34495e; border: 1px solid #7f8c8d;" onclick="printOverlay()">üñ®Ô∏è Aufgaben drucken</button>
            <button class="choice-btn" style="max-width:300px; background:linear-gradient(180deg, #c0392b 0%, #96281b 100%);" onclick="giveUp()">üè≥Ô∏è Ich gebe auf</button>
        </div>
        <button id="btn-quiz-success" class="choice-btn hidden" style="background: #2ecc71; margin-top:20px;" onclick="closeQuizOverlay()">Verstanden. Weiter.</button>
    </div>
</div>

<div id="overlay-crossword" class="overlay hidden">
    <div class="overlay-card">
        <button class="debug-skip-btn" onclick="debugSkip()" title="Aufgabe √ºberspringen (Debug)">‚è≠Ô∏è</button>
        <h2 style="color: #3498db;">Begriffs-Check: Kreuzwortr√§tsel</h2>
        <p style="color: #aaa;">F√ºllen Sie die gesuchten Fachbegriffe ein.</p>
        
        <div id="crossword-container" class="crossword-grid">
            </div>
        <div class="cw-clues">
            <div>1. Waagerecht: Langfristiger Berater (8 B.)</div>
            <div>2. Senkrecht: Prozessbegleitung (8 B.)</div>
            <div>3. Waagerecht: Angestrebtes Ergebnis (5 B.)</div>
        </div>

        <div id="cw-feedback" style="margin-top:15px; font-weight:bold; height:20px;"></div>

        <div style="display:flex; gap:15px; justify-content:center; margin-top:20px;">
            <button class="choice-btn" style="background:#3498db;" onclick="checkCrossword()">Pr√ºfen</button>
            <button class="choice-btn" style="background:#f39c12;" onclick="solveCrossword()">üí° L√∂sung anzeigen</button>
            <button class="choice-btn" style="background:#c0392b;" onclick="giveUp()">üè≥Ô∏è Ich gebe auf</button>
        </div>
        <button id="btn-cw-success" class="choice-btn hidden" style="background: #2ecc71; margin-top:20px;" onclick="closeCrosswordOverlay()">Gel√∂st. Weiter.</button>
    </div>
</div>

<div id="overlay-impressum" class="overlay hidden">
    <div class="overlay-card" style="max-width: 800px;">
        <h2 style="color: var(--gold);">Impressum</h2>
        <div class="impressum-content">
            <h3>Angaben gem√§√ü ¬ß 5 TMG</h3>
            <p>Bildungscampus Leipzig<br>Hebelstra√üe 27<br>04177 Leipzig</p>
            <h3>Vertreten durch</h3>
            <p>Gesch√§ftsleitung: Boris Dahms</p>

            <h3>Kontakt</h3>
            <p>
                Telefon: +49 (0) 123 44 55 66<br>
                E-Mail: mail@bildungscampus-leipzig.de
            </p>

            <h3>Verantwortlich f√ºr den Inhalt nach ¬ß 55 Abs. 2 RStV</h3>
            <p>
                Boris Dahms<br>
            </p>
            
            <h3>Urheberrecht und Haftungsausschluss</h3>
            <div style="font-size: 0.85rem; color: #999; text-align: left;">
                Die vorliegende Pr√§sentation unterliegt dem Urheberrecht. Die Nutzung und Verwendung sowie die Weitergabe darf nur mit ausdr√ºcklicher Genehmigung des Autors erfolgen. Die Pr√§sentation darf ohne ausdr√ºckliche Zustimmung des Autors nicht ver√§ndert werden.<br>
                Eine nichtgenehmigte Verwendung durch Dritte zu Unterrichtszwecken in Bildungseinrichtungen ist ausdr√ºcklich untersagt und f√ºhrt unverz√ºglich zur Strafanzeige und Schadenersatzforderungen.
                Der Autor √ºbernimmt keinerlei Gew√§hr f√ºr die Aktualit√§t, Richtigkeit und Vollst√§ndigkeit der bereitgestellten Informationen. Haftungsanspr√ºche gegen den Autor, welche sich auf Sch√§den materieller oder ideeller Art beziehen, die durch die Nutzung oder Nichtnutzung der dargebotenen Informationen bzw. durch die Nutzung fehlerhafter und unvollst√§ndiger Informationen verursacht wurden, sind grunds√§tzlich ausgeschlossen, sofern seitens des Autors kein nachweislich vors√§tzliches Verschulden vorliegt. Alle Angebote sind freibleibend und unverbindlich. Der Autor beh√§lt es sich ausdr√ºcklich vor, Teile der Seiten oder das gesamte Angebot ohne gesonderte Ank√ºndigung zu ver√§ndern, zu erg√§nzen, zu l√∂schen oder die Ver√∂ffentlichung zeitweise oder endg√ºltig einzustellen.<br>
                Bei direkten oder indirekten Verweisen auf fremde Webseiten (‚ÄúHyperlinks‚Äù), die au√üerhalb des Verantwortungsbereiches des Autors liegen, w√ºrde eine Haftungsverpflichtung ausschlie√ülich in dem Fall in Kraft treten, in dem der Autor von den Inhalten Kenntnis hat und es ihm technisch m√∂glich und zumutbar w√§re, die Nutzung im Falle rechtswidriger Inhalte zu verhindern. Der Autor erkl√§rt hiermit ausdr√ºcklich, dass zum Zeitpunkt der Linksetzung keine illegalen Inhalte auf den zu verlinkenden Seiten erkennbar waren. Auf die aktuelle und zuk√ºnftige Gestaltung, die Inhalte oder die Urheberschaft der verlinkten/verkn√ºpften Seiten hat der Autor keinerlei Einfluss. Deshalb distanziert er sich hiermit ausdr√ºcklich von allen Inhalten aller verlinkten /verkn√ºpften Seiten, die nach der Linksetzung ver√§ndert wurden.<br>
                F√ºr illegale, fehlerhafte oder unvollst√§ndige Inhalte und insbesondere f√ºr Sch√§den, die aus der Nutzung oder Nichtnutzung solcherart dargebotener Informationen entstehen, haftet allein der Anbieter der Seite, auf welche verwiesen wurde, nicht derjenige, der √ºber Links auf die jeweilige Ver√∂ffentlichung lediglich verweist.<br>
                Der Autor ist bestrebt, in allen Publikationen die Urheberrechte der verwendeten Bilder, Grafiken, Tondokumente, Videosequenzen und Texte zu beachten, von ihm selbst erstellte Bilder, Grafiken, Tondokumente, Videosequenzen und Texte zu nutzen oder auf lizenzfreie Grafiken, Tondokumente, Videosequenzen und Texte zur√ºckzugreifen.<br>
                Alle innerhalb des Angebotes genannten und ggf. durch Dritte gesch√ºtzten Marken- und Warenzeichen unterliegen uneingeschr√§nkt den Bestimmungen des jeweils g√ºltigen Kennzeichenrechts und den Besitzrechten der jeweiligen eingetragenen Eigent√ºmer. Allein aufgrund der blo√üen Nennung ist nicht der Schluss zu ziehen, dass Markenzeichen nicht durch Rechte Dritter gesch√ºtzt sind! Das Copyright f√ºr ver√∂ffentlichte, vom Autor selbst erstellte Objekte bleibt allein beim Autor der Seiten. Eine Vervielf√§ltigung oder Verwendung solcher Grafiken, Tondokumente, Videosequenzen und Texte in anderen elektronischen oder gedruckten Publikationen ist ohne ausdr√ºckliche Zustimmung des Autors nicht gestattet.<br><br>
                Leipzig 2025 Boris Dahms
            </div>

            <button class="choice-btn" onclick="closeImpressum()">Schlie√üen</button>
        </div>
    </div>
</div>

<div id="overlay-cert" class="overlay hidden">
    <div class="certificate-container">
        <h1 style="color:var(--gold); margin-bottom:10px;">Zertifikat</h1>
        <h3 style="margin-top:0; color:#555;">Bildungscampus Leipzig</h3>
        <hr style="border:1px solid #ddd; margin: 20px 0;">

        <p>Hiermit wird best√§tigt, dass</p>
        <h2 id="cert-player-name" style="font-size: 2rem; margin: 10px 0;"></h2>
        <p>das Planspiel "PlanA GmbH" erfolgreich absolviert hat.</p>

        <h2 id="cert-grade-title" style="margin-top: 30px;"></h2>
        <p id="cert-grade-text" style="font-size: 1.1rem; color: #666;"></p>

        <div style="margin-top: 40px; display:flex; gap:10px; justify-content:center;">
             <button class="choice-btn" style="background:#34495e; color:white; width:auto;" onclick="window.print()">üñ®Ô∏è Ausdrucken</button>
             <button class="choice-btn" style="background:#e74c3c; color:white; width:auto;" onclick="location.reload()">üîÑ Neustart</button>
        </div>
    </div>
</div>

<script>
    // Charaktere / Bilder
    const IMAGES = {
        sascha: 'sascha.png',
        horst: 'horst.png',
        chef: 'chef.png',
        verwaltung: 'verwaltung.png',
        azubis: 'azubis.png',
        // klara wurde entfernt, um das neue Emoji-Fallback zu erzwingen
        alex: 'alex.png',
        claudia: 'claudia.png',
        viola: 'viola.png',
        erik: 'erik.png',
        sebastian: 'sebastian.png'
    };

    // Charaktere mit spezifischem Duktus-Hinweis f√ºr den User
    const CHAR_DESCRIPTIONS = {
        'chef': "<b>Dr. Peter Planer (Gesch√§ftsf√ºhrung)</b><br>Ein Vision√§r, manchmal ein bisschen unkonzentriert.<br><i>\"Ich sehe Horizonte... aber wo ist meine Brille?\"</i>",
        'horst': "<b>Horst Hektik (Ausbildungsleiter PlanA GmbH)</b><br>Praktiker vom Bau. Hat einen sehr speziellen Humor.<br><i>\"Was ist schwerer? 1 kg Stahl oder 1 kg Federn?\"</i>",
        'verwaltung': "<b>Franziska Immerda (Verwaltung)</b><br>Zuvorkommend, hilfsbereit, aber bestimmt. Beh√§lt das Gro√üe und Ganze im Blick.<br><i>\"Ordnung muss sein.\"</i>",
        'sascha': "<b>Sascha AEVO (Verantwortlicher Ausbilder)</b><br>Pflichtbewusst, modern und wertsch√§tzend. Offen f√ºr Neuerungen.<br><i>\"Lass uns das gemeinsam angehen.\"</i>",
        'klara': "<b>Dr. Klara Kompetenz (Personalleitung)</b><br>H√∂flich, wertsch√§tzend und motivierend. √úbt Kritik nur an der Sache.<br><i>\"Wir finden eine p√§dagogische L√∂sung.\"</i>",
        'alex': "<b>Alex Engagiert (Betriebsrat)</b><br>Achtet auf Bed√ºrfnisse der Mitarbeitenden. Wird bei Verst√∂√üen sehr deutlich.<br><i>\"Haben wir an die Kollegen gedacht?\"</i>",
        'claudia': "<b>Claudia Papierkram (Verwaltung/KI)</b><br>Effizient, freundlich und pedantisch. Liebt KI und R√§tsel.<br><i>\"Effizienz durch Struktur.\"</i>",
        'viola': "<b>Viola Communikationis (Inklusion)</b><br>Fachpraktikerausbilderin. Spricht langsam und deutlich.<br><i>\"Wir m√ºssen barrierefrei denken.\"</i>",
        'erik': "<b>Erik Handycap (Sozialarbeit)</b><br>Bildet gerne lange, ausschweifende Schachtels√§tze.<br><i>\"In Anbetracht der Umst√§nde, die...\"</i>",
        'sebastian': "<b>Sebastian Domini (Technik)</b><br>Industriemeister Metall/Mechatronik. Kommt aus der Produktion.<br><i>\"Das muss technisch funktionieren.\"</i>"
    };

    let state = { time: 150, budget: 100, mood: 100, currentScene: 'intro', giveUpCount: 0 };
    let historyStack = [];
    let resumeSceneAfterIntervention = ''; 

    // --- KI-KONFIGURATION (DQR 7 NIVEAU) ---
    const aiScenarios = {
    "hb4_digital": {
        "title": "<span style='color:white;'>Aufgabe:</span> Digitale Transformation der Ausbildung",
        "intro": "<b>Dr. Klara Kompetenz (Personalleitung):</b> 'Verehrter Kollege, wir stehen vor einer paradigmatischen Wende. Die PlanA Soft KG expandiert in den <b>Sanit√§r-, Heizungs- und Klimatechnik (SHK)</b> Bereich. Ich ben√∂tige Ihre Expertise: Welche Anforderungen stellen wir an <b>Lernaufgaben</b>, um der digitalen Transformation gerecht zu werden? Bitte differenzieren Sie nach √ºberfachlichen Kompetenzen und methodischen Ans√§tzen.'",
        "keywords": [
            "digitale zwillinge",
            "selbststeuerung",
            "√ºberfachlich",
            "kooperationstools",
            "prozessorientierung",
            "lerntechniken"
        ],
        "thresholds": {
            "30": "Zu oberfl√§chlich f√ºr DQR 7.",
            "70": "Gute Ans√§tze, bitte pr√§ziser.",
            "100": "Exzellente strategische Ableitung!"
        },
        "solutionHint": "Fokus: Digitale Zwillinge, Selbststeuerung, Methodenkompetenz, Softskills.",
        "gradingPrompt": "Du bist Dr. Klara Kompetenz. Bewerte streng akademisch (DQR 7). Erwarte Begriffe wie 'Digitale Zwillinge', 'Selbststeuerung'."
    },
    "hb1_sozial": {
        "title": "<span style='color:white;'>Aufgabe:</span> Lernprozesse & Sozialkompetenz",
        "intro": "<b>Dr. Klara Kompetenz (Personalleitung):</b> 'Ein bedauerlicher Vorfall. Ein Azubi vergreift sich im Ton. Herr Hektik pl√§diert f√ºr K√ºndigung. Das ist mir zu... unp√§dagogisch. Entwickeln Sie bitte eine Intervention zur F√∂rderung der <b>Sozialkompetenz</b>. Ich erwarte ein fundiertes Konzept, keine blo√üe Strafe.'",
        "keywords": [
            "feedback",
            "reflexion",
            "verhaltenskodex",
            "perspektivwechsel",
            "kommunikationstraining",
            "ursachenanalyse"
        ],
        "thresholds": {
            "30": "Das ist keine p√§dagogische Intervention.",
            "70": "Solider Ansatz.",
            "100": "Hervorragend differenziert!"
        },
        "solutionHint": "Fokus: Feedback-Gespr√§ch, Reflexion der Sprachwirkung, gemeinsamer Verhaltenskodex.",
        "gradingPrompt": "Bewerte als Dr. Klara Kompetenz. Sei wertsch√§tzend, aber fordere p√§dagogische Tiefe."
    },
    "hb2_recruit": {
        "title": "<span style='color:white;'>Aufgabe:</span> Planungsprozesse (Ausland)",
        "intro": "<b>Dr. Peter Planer (Gesch√§ftsf√ºhrung):</b> 'Ich sehe... Horizonte! Wir brauchen Fachkr√§fte. Aus dem Ausland! Aber wie? Planen Sie das Marketing und das Interview. Denken Sie an... alles!'<br><b>Alex Engagiert (Betriebsrat):</b> 'Und vergessen Sie mir den Betriebsrat nicht!'",
        "keywords": [
            "anerkennung",
            "betriebsrat",
            "kultur",
            "dolmetscher",
            "onboarding",
            "qualifikationsbedarf"
        ],
        "thresholds": {
            "30": "Wichtige Stakeholder vergessen.",
            "70": "Strukturiert.",
            "100": "Strategisch umfassend!"
        },
        "solutionHint": "Fokus: ¬ß99 BetrVG, Anerkennung Abschl√ºsse, Kulturelle Sensibilit√§t, Dolmetscher.",
        "gradingPrompt": "Bewerte strategisch. Pr√ºfe, ob Betriebsrat und kulturelle Aspekte genannt sind."
    },
    "hb3_genz": {
        "title": "<span style='color:white;'>Aufgabe:</span> Management & Bindung (Gen Z)",
        "intro": "<b>Horst Hektik (Ausbildungsleiter PlanA GmbH):</b> 'Die Jungen hauen alle ab. Wollen Sabbatical. Pff. Mach was.'<br><b>Sascha AEVO (Verantwortlicher Ausbilder):</b> 'Wir m√ºssen ihre Werte verstehen, Horst. Erstellen Sie ein Retention-Konzept.'",
        "keywords": [
            "sinnstiftung",
            "flexibilit√§t",
            "cafeteria-prinzip",
            "werte",
            "work-life-balance",
            "karrierepfade"
        ],
        "thresholds": {
            "30": "Zu monet√§r gedacht.",
            "70": "Gute Ans√§tze.",
            "100": "Exzellentes Verst√§ndnis der Zielgruppe!"
        },
        "solutionHint": "Fokus: Cafeteria-Modell, Sinnstiftung, Flexibilisierung der Arbeit.",
        "gradingPrompt": "Bewerte modern und lebensweltorientiert."
    },
    "hb5_transfer": {
        "title": "<span style='color:white;'>Aufgabe:</span> Weiterbildung (Transfergesellschaft)",
        "intro": "<b>Erik Handycap (Sozialarbeit):</b> 'In Anbetracht der bedauerlichen Insolvenz eines Teilbereichs, und unter Ber√ºcksichtigung der sozialen Verantwortung, die wir zweifelsohne tragen, ist es unabdingbar, eine Transfergesellschaft zu gr√ºnden, deren prim√§res Ziel es sein muss...' <br><i>(Er redet noch 5 Minuten weiter)</i><br><b>Viola Communikationis (Inklusion):</b> 'Erik. Meint. Wir. M√ºssen. 50. Leute. Retten. Wir brauchen eine <b>Bildungsbedarfsanalyse</b>.'",
        "keywords": [
            "anforderungsprofil",
            "soll-ist-vergleich",
            "einzelgespr√§che",
            "kompetenzprofil",
            "empathie",
            "arbeitsmarktanalyse"
        ],
        "thresholds": {
            "30": "Zu wenig Struktur.",
            "70": "Guter Leitfaden.",
            "100": "Hervorragend strukturiert und empathisch!"
        },
        "solutionHint": "Fokus: Profiling, Einzelgespr√§che, Abgleich mit Arbeitsmarktchancen.",
        "gradingPrompt": "Achte auf Struktur und Empathie im Prozess."
    },
    "hb6_karriere": {
        "title": "<span style='color:white;'>Aufgabe:</span> Personalentwicklung (Karrierewege)",
        "intro": "<b>Claudia Papierkram (Verwaltung/KI):</b> 'Ich habe die Daten analysiert. Unsere Effizienz leidet unter Motivationstiefs. Die Leute sehen keinen Aufstieg. Wir brauchen systematische <b>Laufbahnmodelle</b>. Meine KI sagt: Das erh√∂ht die Retention um 40%.'",
        "keywords": [
            "fachlaufbahn",
            "f√ºhrungslaufbahn",
            "projektlaufbahn",
            "durchl√§ssigkeit",
            "anforderungsprofile",
            "transparenz"
        ],
        "thresholds": {
            "30": "Nur F√ºhrungslaufbahn bedacht?",
            "70": "Gute Systematik.",
            "100": "Exzellente Differenzierung (Fach/F√ºhrung/Projekt)!"
        },
        "solutionHint": "Fokus: Fachlaufbahn vs. F√ºhrungslaufbahn vs. Projektlaufbahn.",
        "gradingPrompt": "Bewerte die Systematik der Laufbahnmodelle."
    },
    "sebastian_eval_feedback": {
        "title": "<span style='color:white;'>Frage:</span> Evaluation vs. Feedback",
        "intro": "<b>Sebastian Domini (Technik):</b> 'Chef, ich hab hier zwei Azubis. Der eine will Feedback, der andere fragt nach der Evaluation seiner Leistung. F√ºr mich ist das alles dasselbe: Ich sag denen, was sie falsch gemacht haben. Oder gibt es da theoretisch einen Unterschied, den ich als Meister kennen sollte?'",
        "keywords": [
            "prozess",
            "ergebnis",
            "formativ",
            "summativ",
            "individuell",
            "systematisch",
            "entwicklung",
            "beurteilung"
        ],
        "thresholds": {
            "30": "Zu ungenau.",
            "70": "Gute Unterscheidung.",
            "100": "Perfekte p√§dagogische Differenzierung!"
        },
        "solutionHint": "Feedback ist prozessorientiert/formativ/individuell (Lernbegleitung). Evaluation ist ergebnisorientiert/summativ/systematisch (Bewertung/Erfolgskontrolle).",
        "gradingPrompt": "Du bist Sebastian Domini, ein pragmatischer Meister. Bewerte die Erkl√§rung. Erwarte Begriffe wie 'Prozess vs. Ergebnis' oder 'formativ vs. summativ'."
    }
};
    let currentAiId = null;

    // --- QUIZ DATEN (Rechtliche Absicherung & EXPERTENKLAUSUR) ---
    const quizzes = {
    "jarbschg_zeit": {
        "title": "<span style='color:white;'>Aufgabe:</span> JArbSchG - Arbeitszeit & Aufsicht",
        "intro": "<b>Franziska Immerda (Verwaltung):</b> 'Der Vorfall mit Kevin an der Kreiss√§ge hat hohe Wellen geschlagen. Die Berufsgenossenschaft pr√ºft jetzt genau. Beweisen Sie Ihre Rechtssicherheit in Bezug auf Arbeitszeit und gef√§hrliche Arbeiten.'",
        "law": "<strong>¬ß 22 JArbSchG</strong>: Besch√§ftigung bei gef√§hrlichen Arbeiten nur unter Aufsicht.<br><strong>¬ß 8 JArbSchG</strong>: Max 40h/Woche.",
        "questions": [
            {
                "q": "Darf Kevin (16) alleine an die Kreiss√§ge?",
                "options": [
                    {
                        "text": "Ja, wenn es eilt",
                        "val": false
                    },
                    {
                        "text": "Nein, verboten",
                        "val": true
                    }
                ]
            },
            {
                "q": "Max. Wochenarbeitszeit Jugendlicher?",
                "options": [
                    {
                        "text": "40 Std",
                        "val": true
                    },
                    {
                        "text": "48 Std",
                        "val": false
                    }
                ]
            }
        ]
    },
    "pe_instrumente": {
        "title": "<span style='color:white;'>Aufgabe:</span> PE-Instrumente (DQR 7 Check)",
        "intro": "<b>Dr. Klara Kompetenz (Personalleitung):</b> 'Strategische Personalentwicklung erfordert pr√§zises Vokabular. Bevor wir Konzepte schreiben, m√ºssen die Begriffe sitzen. Differenzieren Sie bitte:'",
        "law": "Strategische PE nutzt diverse Instrumente zur Bedarfsdeckung.",
        "questions": [
            {
                "q": "Was ist Job Enrichment?",
                "options": [
                    {
                        "text": "Mehr Aufgaben gleiches Niveau",
                        "val": false
                    },
                    {
                        "text": "H√∂heres Anforderungsniveau",
                        "val": true
                    }
                ]
            },
            {
                "q": "Ziel von Coaching?",
                "options": [
                    {
                        "text": "Hilfe zur Selbsthilfe",
                        "val": true
                    },
                    {
                        "text": "Fachberatung",
                        "val": false
                    }
                ]
            },
            {
                "q": "Was ist Job Rotation?",
                "options": [
                    {
                        "text": "Geplanter Wechsel",
                        "val": true
                    },
                    {
                        "text": "K√ºndigung",
                        "val": false
                    }
                ]
            }
        ]
    },
    "quiz_pe_expert": {
        "title": "<span style='color:white;'>Aufgabe:</span> Expertenwissen Personalentwicklung & F√ºhrung",
        "intro": "<b>Dr. Klara Kompetenz:</b> 'Bevor ich meine Agenden √ºbergebe, muss ich sicher sein, dass Sie die strategischen Zusammenh√§nge durchdrungen haben. Beweisen Sie Ihre Expertise in dieser Klausur.'",
        "law": "Hinweis: Diese Fragen basieren auf dem Handlungsbereich 6 (Personalentwicklung und Beratung).",
        "questions": [
            {
                "q": "Was ist ein zentrales Ziel der Personalentwicklung (PE)?",
                "options": [
                    {
                        "text": "Gewinnmaximierung der einzelnen Mitarbeiter.",
                        "val": false
                    },
                    {
                        "text": "Mitarbeiter auf k√ºnftige Entwicklungen (z.B. technologischen Wandel) vorzubereiten.",
                        "val": true
                    }
                ]
            },
            {
                "q": "Was wird in einer Qualifikationsmatrix gegen√ºbergestellt?",
                "options": [
                    {
                        "text": "Ist-Qualifikationen vs. Soll-Anforderungen.",
                        "val": true
                    },
                    {
                        "text": "Gehaltsw√ºnsche vs. Budget.",
                        "val": false
                    }
                ]
            },
            {
                "q": "Was kennzeichnet eine betriebliche Laufbahnplanung?",
                "options": [
                    {
                        "text": "Sie beschreibt nur den Lebenslauf vor der Einstellung.",
                        "val": false
                    },
                    {
                        "text": "Sie b√ºndelt Entwicklungs- und Aufstiegsm√∂glichkeiten zur Mitarbeiterbindung.",
                        "val": true
                    }
                ]
            },
            {
                "q": "Welche Phasen umfasst eine professionelle Mitarbeiterbeurteilung?",
                "options": [
                    {
                        "text": "Beobachtung, Bewertung und Besprechung.",
                        "val": true
                    },
                    {
                        "text": "Nur die spontane Bewertung aus dem Bauch heraus.",
                        "val": false
                    }
                ]
            },
            {
                "q": "Was ist das prim√§re Ziel eines Coachings?",
                "options": [
                    {
                        "text": "Fachliche Anweisungen geben.",
                        "val": false
                    },
                    {
                        "text": "Hilfe zur Selbsthilfe leisten.",
                        "val": true
                    }
                ]
            }
        ]
    },
    "viola_comm_quiz": {
        "title": "Konfliktmanagement & Gespr√§che",
        "intro": "<b>Viola Communikationis (Inklusion):</b> 'Kommunikation ist der Schl√ºssel. Bitte √ºberpr√ºfen Sie diese Grundlagen, bevor wir in die Gespr√§che gehen.'",
        "law": "Kommunikation ist der Schl√ºssel zur Inklusion und Probleml√∂sung.",
        "questions": [
            {
                "q": "Welche Gespr√§chsform ist 'anlassbezogen'?",
                "options": [
                    {
                        "text": "Jahresgespr√§ch",
                        "val": false
                    },
                    {
                        "text": "R√ºckkehrgespr√§ch",
                        "val": true
                    },
                    {
                        "text": "Zielvereinbarungsgespr√§ch",
                        "val": false
                    }
                ]
            },
            {
                "q": "Was ist das Ziel eines Kritikgespr√§chs?",
                "options": [
                    {
                        "text": "Mitarbeiter bestrafen",
                        "val": false
                    },
                    {
                        "text": "Ursachen erkennen & Verhalten √§ndern",
                        "val": true
                    }
                ]
            },
            {
                "q": "Was kennzeichnet 'Aktives Zuh√∂ren'?",
                "options": [
                    {
                        "text": "Sofortige Ratschl√§ge geben",
                        "val": false
                    },
                    {
                        "text": "Paraphrasieren & Gef√ºhle spiegeln",
                        "val": true
                    }
                ]
            }
        ]
    },
    "erik_coaching_quiz": {
        "title": "Coaching & Lernf√∂rderung",
        "intro": "<b>Erik Handycap (Sozialarbeit):</b> 'Reflexion ist essenziell. Helfen Sie mir, diese Begriffe sauber zu trennen.'",
        "law": "Coaching ist Hilfe zur Selbsthilfe, keine Fachberatung.",
        "questions": [
            {
                "q": "Wer ist f√ºr die L√∂sung im Coaching verantwortlich?",
                "options": [
                    {
                        "text": "Der Coach",
                        "val": false
                    },
                    {
                        "text": "Der Coachee (Klient)",
                        "val": true
                    }
                ]
            },
            {
                "q": "Was geh√∂rt zur 'Kl√§rungsphase' im Coaching?",
                "options": [
                    {
                        "text": "Vertragsabschluss",
                        "val": false
                    },
                    {
                        "text": "Ist-Soll-Analyse & Einbindung Beteiligter",
                        "val": true
                    }
                ]
            },
            {
                "q": "Was ist 'Job Rotation'?",
                "options": [
                    {
                        "text": "Systematischer Arbeitsplatzwechsel",
                        "val": true
                    },
                    {
                        "text": "Erweiterung des Aufgabenfeldes",
                        "val": false
                    }
                ]
            }
        ]
    }
};
    let currentQuizId = null;

    // --- STORY SCENES ---
    const scenes = {
    "intro": {
        "title": "",
        "text": "\n                <div class=\"intro-title\">Willkommen<br>im Bildungscampus Leipzig</div>\n                \n                <p style=\"text-align: justify;\">Wir sind ein neu gegr√ºndetes Bildungsunternehmen in Leipzig und bieten vorrangig\nPr√§senz- und Onlineschulungen in den Bereichen Aus- und Weiterbildungsp√§dagogik, Berufsp√§dagogik, Ausbildereignung, Personalwirtschaft und B√ºromanagement an.<br><br>\nSeit kurzer Zeit bilden wir in einem Ausbildungsverbund mit der PlanA GmbH im handwerklichen Bereich auch Tischler aus. Ein Teil dieser Ausbildung findet in einer Produktionslinie der PlanA GmbH statt. Es existiert auch eine eigene Lehrwerkstatt.\n\n \n\n                <p style=\"text-align: justify;\">Wir besch√§ftigen zur Zeit 8 Mitarbeitende sowie mehrere freiberufliche Dozent*innen</p>\n\n                <div class=\"team-grid\">\n                    <div class=\"team-role\">Gesch√§ftsf√ºhrung:</div><div class=\"team-name\">Dr. Peter Planer</div>\n                    <div class=\"team-role\">Personalleitung:</div><div class=\"team-name\">Dr. Klara Kompetenz</div>\n                    <div class=\"team-role\">Ausbildungleiter PlanA GmbH:</div><div class=\"team-name\">Horst Hektik</div>\n                    <div class=\"team-role\">Verantwortlicher Ausbilder:</div><div class=\"team-name\">Sascha AEVO</div>\n                    <div class=\"team-role\">Verwaltung:</div><div class=\"team-name\">Franziska Immerda</div>\n                    <div class=\"team-role\">Betriebsrat:</div><div class=\"team-name\">Alex Engagiert</div>\n                    <div class=\"team-role\">weitere Mitarbeitende:</div><div class=\"team-name\">Claudia Papierkram, Viola Communikationis,<br> Erik Handycap und Sebastian Domini</div>\n                </div>\n            ",
        "leftContent": "\n                <div class=\"role-box-left\">\n                    <span class=\"role-title\">IHRE MISSION</span>\n                    <div class=\"role-description\">\n                        Sie sind als Gepr. Berufsp√§dagog*in die neue <b>\"Hauptabteilungsleitung Bildung\" mit Personalbefugnissen</b>.<br>\nIn diesem Planspiel m√ºssen Sie unter Zeitdruck verschiedene Problemstellungen l√∂sen. \n                    </div>\n                    <button class=\"start-btn-green\" onclick=\"startGame()\">Rolle annehmen & starten </button>\n                </div>\n            ",
        "char": "chef",
        "charName": "Dr. Peter Planer",
        "options": []
    },
    "start": {
        "title": "Der Ernstfall",
        "text": "<b>Horst Hektik (Ausbildungsleiter PlanA GmbH):</b> 'Tach. H√∂r mal. Der Kevin. 16 Jahre. Soll an die Kreiss√§ge. Sofort. Auftrag muss raus. Personal fehlt. Mach da kein Drama draus, ja? √úbrigens: Was macht ein Clown im B√ºro? - Faxen. Hahaha! Aber im Ernst jetzt: Unterschreib das.'",
        "char": "horst",
        "charName": "Horst Hektik",
        "options": [
            {
                "text": "Genehmigen (Produktion first)",
                "next": "fail_jarbschg",
                "costTime": 2
            },
            {
                "text": "Ablehnen (Gef√§hrliche Arbeit)",
                "next": "success_jarbschg",
                "costTime": 5
            }
        ]
    },
    "fail_jarbschg": {
        "title": "Rechtsbruch!",
        "text": "<b>Franziska Immerda (Verwaltung):</b> 'Ich muss doch sehr bitten! ¬ß 22 JArbSchG. Ohne Aufsicht? Unm√∂glich. Ich habe die BG schon am Telefon gehabt. Das geht so nicht!'",
        "char": "verwaltung",
        "charName": "Franziska Immerda",
        "moodChange": -20,
        "options": [
            {
                "text": "Rechtskenntnisse auffrischen",
                "next": "quiz_jarb",
                "costTime": 10
            }
        ]
    },
    "quiz_jarb": {
        "special": "quiz",
        "quizId": "jarbschg_zeit",
        "next": "success_jarbschg"
    },
    "success_jarbschg": {
        "title": "Konflikt gel√∂st",
        "text": "<b>Sascha AEVO (Verantwortlicher Ausbilder):</b> 'Danke. Horst ist zwar sauer, aber wir haben einen Unfall verhindert. Und Rechtssicherheit gewahrt. Das war professionell.'",
        "char": "sascha",
        "charName": "Sascha AEVO",
        "options": [
            {
                "text": "Zum Termin mit Dr. Kompetenz",
                "next": "klara_audit",
                "costTime": 5
            }
        ]
    },
    "klara_audit": {
        "title": "<span style='color:white;'>Aufgabe:</span> Digitale Wende",
        "text": "<b>Dr. Klara Kompetenz (Personalleitung):</b> 'Guten Tag. Ich freue mich, dass Sie da sind. Sehen Sie, wir expandieren in den SHK-Bereich. Unsere Didaktik ist jedoch... nun ja... antiquiert. Ich erbitte ein Konzept zur <b>digitalen Transformation</b> der Lernaufgaben.'",
        "char": "klara",
        "charName": "Dr. Klara Kompetenz",
        "options": [
            {
                "text": "Konzept erstellen",
                "next": "ai_digital",
                "costTime": 15
            },
            {
                "text": "Ablehnen ('Zu neumodisch')",
                "next": "fail_klara_block",
                "costTime": 5
            }
        ]
    },
    "fail_klara_block": {
        "title": "Irritation",
        "text": "<b>Dr. Klara Kompetenz (Personalleitung):</b> 'Ich bin entt√§uscht. Stillstand ist R√ºckschritt. Ich erwarte von Ihnen Innovationsgeist, keine Blockadehaltung. Bitte √ºberdenken Sie das.'",
        "char": "klara",
        "charName": "Dr. Klara Kompetenz",
        "moodChange": -30,
        "options": [
            {
                "text": "Konzept doch erstellen",
                "next": "ai_digital",
                "costTime": 5
            }
        ]
    },
    "ai_digital": {
        "special": "ai_question",
        "aiId": "hb4_digital",
        "next": "social_issue"
    },
    "social_issue": {
        "title": "<span style='color:white;'>Aufgabe:</span> Der Vorfall",
        "text": "<b>Horst Hektik (Ausbildungsleiter PlanA GmbH):</b> 'Der Stift hat 'Hurensohn' gesagt. Zu mir. Der fliegt. Sofort. Papiere fertig machen! Chuck Norris w√ºrde ihn einfach... na du wei√üt schon.'<br><br><b>Dr. Klara Kompetenz (Personalleitung):</b> 'Herr Hektik, bitte m√§√üigen Sie sich. Wir k√ºndigen nicht affektgesteuert. Das ist ein Bildungsauftrag. F√∂rdern Sie die <b>Sozialkompetenz</b>.'",
        "char": "klara",
        "charName": "Dr. Klara Kompetenz",
        "options": [
            {
                "text": "P√§dagogische Intervention",
                "next": "ai_social",
                "costTime": 15
            },
            {
                "text": "Horst zustimmen (K√ºndigung)",
                "next": "fail_pedagogy",
                "costTime": 5
            }
        ]
    },
    "fail_pedagogy": {
        "title": "P√§dagogisches Versagen",
        "text": "<b>Dr. Klara Kompetenz (Personalleitung):</b> 'Sie entt√§uschen mich. Wir sind P√§dagogen, keine Scharfrichter. Versuchen Sie es erneut - mit Verstand!'",
        "char": "klara",
        "charName": "Dr. Klara Kompetenz",
        "moodChange": -20,
        "options": [
            {
                "text": "Neuer Versuch",
                "next": "ai_social",
                "costTime": 5
            }
        ]
    },
    "ai_social": {
        "special": "ai_question",
        "aiId": "hb1_sozial",
        "next": "level_2_intro"
    },
    "level_2_intro": {
        "title": "Zwischenfazit",
        "text": "<b>Dr. Peter Planer (Gesch√§ftsf√ºhrung):</b> 'Ah, da sind Sie ja! Ich hatte gerade eine Vision... oder war es Hunger? Egal. Wir m√ºssen... gr√∂√üer denken! Strategischer! Kommen Sie in mein B√ºro.'",
        "char": "chef",
        "charName": "Dr. Peter Planer",
        "options": [
            {
                "text": "Zur Strategierunde",
                "next": "strategy_recruit",
                "costTime": 0
            }
        ]
    },
    "strategy_recruit": {
        "title": "<span style='color:white;'>Aufgabe:</span> Globales Denken",
        "text": "<b>Dr. Peter Planer (Gesch√§ftsf√ºhrung):</b> 'Der Markt ist leer. Wir m√ºssen... in die Ferne schweifen! Ausland! Rekrutierung! Machen Sie das. Planen Sie alles.'<br><b>Alex Engagiert (Betriebsrat):</b> 'Moment mal! ¬ß 99 BetrVG. Und Integration. Das muss sauber laufen!'",
        "char": "chef",
        "charName": "Dr. Peter Planer",
        "options": [
            {
                "text": "Planungsprozess starten",
                "next": "ai_recruit",
                "costTime": 15
            },
            {
                "text": "Einfach mal Stellenanzeige schalten",
                "next": "fail_recruit",
                "costTime": 5
            }
        ]
    },
    "fail_recruit": {
        "title": "Betriebsrat veto",
        "text": "<b>Alex Engagiert (Betriebsrat):</b> 'So nicht, Freunde. Ohne Konzept zur Eingliederung und ohne meine Zustimmung l√§uft hier gar nichts. Das ist gesetzeswidrig!'",
        "char": "alex",
        "charName": "Alex Engagiert",
        "moodChange": -25,
        "options": [
            {
                "text": "Ordentlich planen",
                "next": "ai_recruit",
                "costTime": 10
            }
        ]
    },
    "ai_recruit": {
        "special": "ai_question",
        "aiId": "hb2_recruit",
        "next": "gen_z_scene"
    },
    "gen_z_scene": {
        "title": "<span style='color:white;'>Aufgabe:</span> Generationenkonflikt",
        "text": "<b>Horst Hektik (Ausbildungsleiter PlanA GmbH):</b> 'Die Jungen hauen alle ab. Wollen Sabbatical. Pff. Mach was.'<br><b>Sascha AEVO (Verantwortlicher Ausbilder):</b> 'Wir m√ºssen ihre Werte verstehen, Horst. Erstellen Sie ein Retention-Konzept.'",
        "char": "horst",
        "charName": "Horst Hektik",
        "options": [
            {
                "text": "Retention-Konzept",
                "next": "ai_genz",
                "costTime": 15
            },
            {
                "text": "Obstkorb hinstellen",
                "next": "fail_obst",
                "costTime": 5
            }
        ]
    },
    "fail_obst": {
        "title": "Das reicht nicht",
        "text": "<b>Sascha AEVO (Verantwortlicher Ausbilder):</b> 'Ein Obstkorb? Ernsthaft? Die jungen Leute wollen Perspektiven und Sinn, keine Bananen.'",
        "char": "sascha",
        "charName": "Sascha AEVO",
        "moodChange": -10,
        "options": [
            {
                "text": "Konzept √ºberarbeiten",
                "next": "ai_genz",
                "costTime": 10
            }
        ]
    },
    "ai_genz": {
        "special": "ai_question",
        "aiId": "hb3_genz",
        "next": "transfer_scene"
    },
    "transfer_scene": {
        "title": "<span style='color:white;'>Aufgabe:</span> Schwere Zeiten",
        "text": "<b>Erik Handycap (Sozialarbeit):</b> 'In Anbetracht der bedauerlichen Insolvenz eines Teilbereichs, und unter Ber√ºcksichtigung der sozialen Verantwortung, die wir zweifelsohne tragen, ist es unabdingbar, eine Transfergesellschaft zu gr√ºnden, deren prim√§res Ziel es sein muss...' <br><i>(Er redet noch 5 Minuten weiter)</i><br><b>Viola Communikationis (Inklusion):</b> 'Erik. Meint. Wir. M√ºssen. 50. Leute. Retten. Wir brauchen eine <b>Bildungsbedarfsanalyse</b>.'",
        "char": "erik",
        "charName": "Erik Handycap",
        "options": [
            {
                "text": "Analyse-Leitfaden erstellen",
                "next": "ai_transfer",
                "costTime": 15
            }
        ]
    },
    "ai_transfer": {
        "special": "ai_question",
        "aiId": "hb5_transfer",
        "next": "career_scene"
    },
    "career_scene": {
        "title": "<span style='color:white;'>Aufgabe:</span> Zukunft",
        "text": "<b>Claudia Papierkram (Verwaltung/KI):</b> 'Ich habe die Daten analysiert. Unsere Effizienz leidet unter Motivationstiefs. Die Leute sehen keinen Aufstieg. Wir brauchen systematische <b>Laufbahnmodelle</b>. Meine KI sagt: Das erh√∂ht die Retention um 40%.'",
        "char": "claudia",
        "charName": "Claudia Papierkram",
        "options": [
            {
                "text": "Laufbahnmodelle entwickeln",
                "next": "ai_career",
                "costTime": 15
            }
        ]
    },
    "ai_career": {
        "special": "ai_question",
        "aiId": "hb6_karriere",
        "next": "klara_leave"
    },
    "klara_leave": {
        "title": "Vertrauliches Gespr√§ch",
        "text": "<b>Dr. Klara Kompetenz (Personalleitung):</b> 'Kommen Sie doch bitte kurz in mein B√ºro. Ich habe Neuigkeiten: Ich werde in den n√§chsten Wochen in den Mutterschutz gehen. Ich brauche jemanden, der meine Aufgaben als Personalleitung vertretungsweise √ºbernimmt. Ich traue Ihnen das zu ‚Äì aber daf√ºr m√ºssen Sie in der Theorie absolut sattelfest sein. Sind Sie bereit f√ºr eine <b>Experten-Weiterbildung</b>?'",
        "char": "klara",
        "charName": "Dr. Klara Kompetenz",
        "options": [
            {
                "text": "Herausforderung annehmen (Weiterbildung starten)",
                "next": "quiz_pe_expert",
                "costTime": 20
            },
            {
                "text": "Ich traue mir das nicht zu",
                "next": "game_over_fail",
                "costTime": 5
            }
        ]
    },
    "quiz_pe_expert": {
        "special": "quiz",
        "quizId": "quiz_pe_expert",
        "next": "crossword_intro"
    },
    "crossword_intro": {
        "title": "Begriffs-Verwirrung",
        "text": "<b>Claudia Papierkram (Verwaltung/KI):</b> 'Hallo! Bevor Sie zu Sebastian gehen... ich sortiere gerade unser Glossar. Meine KI ist abgest√ºrzt und ich muss diese Begriffe manuell zuordnen. Helfen Sie mir kurz beim <b>Kreuzwortr√§tsel</b>? Es geht um PE-Begriffe.'",
        "char": "claudia",
        "charName": "Claudia Papierkram",
        "options": [
            {
                "text": "R√§tsel l√∂sen",
                "next": "crossword_scene",
                "costTime": 10
            }
        ]
    },
    "crossword_scene": {
        "char": "claudia",
        "charName": "Claudia Papierkram",
        "special": "crossword",
        "next": "sebastian_intro",
        "cwId": "crossword_scene_cw_config"
    },
    "sebastian_intro": {
        "title": "Der Praktiker fragt",
        "text": "<b>Sebastian Domini (Technik):</b> 'Gut, dass Sie da sind. Ich habe hier ein theoretisches Problem in der Werkstatt. Meine Azubis wollen Feedback, die IHK will Evaluation. Wo liegt denn da genau der Unterschied? K√∂nnen Sie mir das kurz und knapp erkl√§ren, damit ich nichts Falsches erz√§hle?'",
        "char": "sebastian",
        "charName": "Sebastian Domini",
        "options": [
            {
                "text": "Unterschied erkl√§ren",
                "next": "ai_sebastian",
                "costTime": 10
            }
        ]
    },
    "ai_sebastian": {
        "special": "ai_question",
        "aiId": "sebastian_eval_feedback",
        "next": "sebastian_thanks"
    },
    "sebastian_thanks": {
        "title": "Erkenntnis",
        "text": "<b>Sebastian Domini (Technik):</b> 'Aha! Feedback f√ºr den Prozess, Evaluation f√ºr das Ergebnis. Verstanden. Das hilft mir sehr. Danke f√ºr die Aufkl√§rung! <br><br> √úbrigens, Viola sucht Sie schon. Es gibt wohl Redebedarf.'",
        "char": "sebastian",
        "charName": "Sebastian Domini",
        "moodChange": 10,
        "options": [
            {
                "text": "Zu Viola Communikationis gehen",
                "next": "viola_intro",
                "costTime": 5
            }
        ]
    },
    "viola_intro": {
        "title": "Gespr√§chsbedarf",
        "text": "<b>Viola Communikationis (Inklusion):</b> 'Hallo. Ich brauche Ihre Unterst√ºtzung. Wir haben einige Konflikte im Team, und ich m√∂chte sicherstellen, dass unsere Kritikgespr√§che barrierefrei und wertsch√§tzend ablaufen. K√∂nnen Sie mein Wissen zu <b>Gespr√§chsf√ºhrung</b> kurz √ºberpr√ºfen?'",
        "char": "viola",
        "charName": "Viola Communikationis",
        "options": [
            {
                "text": "Wissen √ºberpr√ºfen (Quiz)",
                "next": "quiz_viola",
                "costTime": 10
            }
        ]
    },
    "quiz_viola": {
        "special": "quiz",
        "quizId": "viola_comm_quiz",
        "next": "viola_thanks"
    },
    "viola_thanks": {
        "title": "Barrierefrei kommunizieren",
        "text": "<b>Viola Communikationis (Inklusion):</b> 'Vielen Dank. Das gibt mir Sicherheit. Besonders das aktive Zuh√∂ren ist wichtig. Ich werde das sofort im n√§chsten Meeting anwenden.<br><br>Erik wartet √ºbrigens im B√ºro nebenan.'",
        "char": "viola",
        "charName": "Viola Communikationis",
        "moodChange": 10,
        "options": [
            {
                "text": "Zu Erik Handycap gehen",
                "next": "erik_intro",
                "costTime": 5
            }
        ]
    },
    "erik_intro": {
        "title": "Hilfe zur Selbsthilfe",
        "text": "<b>Erik Handycap (Sozialarbeit):</b> 'In Anbetracht der komplexen psychosozialen Dynamiken... kurz gesagt: Ich coache gerade einen Mitarbeiter in einer schwierigen Phase. Ich m√∂chte sichergehen, dass ich die Rolle des Coaches richtig interpretiere. D√ºrfte ich Sie um eine kurze fachliche Einsch√§tzung bitten?'",
        "char": "erik",
        "charName": "Erik Handycap",
        "options": [
            {
                "text": "Coaching-Kompetenz checken (Quiz)",
                "next": "quiz_erik",
                "costTime": 10
            }
        ]
    },
    "quiz_erik": {
        "special": "quiz",
        "quizId": "erik_coaching_quiz",
        "next": "erik_thanks"
    },
    "erik_thanks": {
        "title": "Klarheit",
        "text": "<b>Erik Handycap (Sozialarbeit):</b> 'Ausgezeichnet. Die Abgrenzung zur Fachberatung war der entscheidende Punkt. Ich danke Ihnen vielmals f√ºr diese kollegiale Beratung.<br><br>Ich glaube, Dr. Kompetenz wollte Sie nun abschlie√üend sprechen.'",
        "char": "erik",
        "charName": "Erik Handycap",
        "moodChange": 10,
        "options": [
            {
                "text": "Zum Abschlussgespr√§ch",
                "next": "calculate_score",
                "costTime": 5
            }
        ]
    },
    "calculate_score": {
        "title": "Abschluss",
        "text": "<b>Dr. Peter Planer (Gesch√§ftsf√ºhrung):</b> 'Nun, das war eine beeindruckende Tour de Force. Meine Visionen wurden... nun ja, konkretisiert. Lassen Sie uns sehen, was dabei herausgekommen ist. Hier ist Ihr Ergebnis.'<br><br><i>(Er unterschreibt das Dokument mit Schwung.)</i>",
        "char": "chef",
        "charName": "Dr. Peter Planer",
        "options": [
            {
                "text": "Zertifikat entgegennehmen üìú",
                "specialExec": "showCertificate"
            }
        ]
    },
    "game_over_fail": {
        "title": "Entlassen",
        "text": "Sie haben das Unternehmen ruiniert oder wichtige Chancen verpasst.",
        "char": "chef",
        "options": []
    },
    "resolve_warning": {
        "specialExec": "resolveWarning"
    },
    "giveup_1_talk": {
        "title": "Motivierende Ermahnung",
        "text": "<b>Dr. Klara Kompetenz (Personalleitung):</b> 'H√∂ren Sie mal, ich sehe, dass Sie diese Aufgabe abgebrochen haben. Lassen Sie den Kopf nicht h√§ngen! Aller Anfang ist schwer. Ich empfehle Ihnen dringend, sich Zeit f√ºr das Selbststudium in unserer Bibliothek zu nehmen. Versuchen Sie es danach erneut ‚Äì ich wei√ü, dass Sie das k√∂nnen!'",
        "char": "klara",
        "charName": "Dr. Klara Kompetenz",
        "moodChange": -10,
        "options": [
            {
                "text": "Danke, ich versuche es weiter.",
                "specialExec": "resumeIntervention"
            }
        ]
    },
    "giveup_2_warning": {
        "title": "M√ºndliche Verwarnung",
        "text": "<b>Dr. Klara Kompetenz (Personalleitung):</b> 'Sie haben erneut eine Aufgabe verweigert. Das entspricht nicht dem F√ºhrungsanspruch, den wir hier haben. Ich spreche Ihnen hiermit eine m√ºndliche Verwarnung aus. Wir erwarten L√∂sungen, keine Kapitulation.'",
        "char": "klara",
        "charName": "Dr. Klara Kompetenz",
        "moodChange": -20,
        "options": [
            {
                "text": "Ich werde mich bessern.",
                "specialExec": "resumeIntervention"
            }
        ]
    },
    "giveup_3_written": {
        "title": "Schriftliche Abmahnung",
        "text": "<b>Dr. Klara Kompetenz (Personalleitung):</b> 'Das ist nun das dritte Mal. Wir sind zutiefst entt√§uscht. Hiermit √ºberreiche ich Ihnen eine formelle, schriftliche Abmahnung wegen Arbeitsverweigerung. Dies ist Ihre allerletzte Chance.'",
        "char": "klara",
        "charName": "Dr. Klara Kompetenz",
        "moodChange": -40,
        "options": [
            {
                "text": "Ich habe verstanden.",
                "specialExec": "resumeIntervention"
            }
        ]
    },
    "giveup_4_fired": {
        "title": "K√ºndigung",
        "text": "<b>Dr. Peter Planer (Gesch√§ftsf√ºhrung):</b> 'Es reicht. Frau Dr. Kompetenz hat mich informiert. Vier mal aufgegeben? Das Vertrauensverh√§ltnis ist zerst√∂rt. Sie sind hiermit fristlos gek√ºndigt. Bitte r√§umen Sie Ihren Schreibtisch.'",
        "char": "chef",
        "charName": "Dr. Peter Planer",
        "options": []
    }
};

    // --- ENGINE ---
    function renderScene(sceneKey) {
        state.currentScene = sceneKey;
        const scene = scenes[sceneKey];
        
        const imgEl = document.getElementById('char-image');
        const fallbackEl = document.getElementById('char-fallback');
        const bgContainer = document.getElementById('char-bg');
        const nameBadge = document.getElementById('char-name');

        if (IMAGES[scene.char]) {
            imgEl.src = IMAGES[scene.char]; imgEl.style.display = 'block'; fallbackEl.style.display = 'none';
        } else {
            imgEl.style.display = 'none'; fallbackEl.style.display = 'block';
            if (scene.char === 'klara') {
                fallbackEl.innerHTML = 'üë©üèæ‚Äçüè´';
            } else {
                let emoji = 'üë®‚Äçüíº';
                if (scene.char === 'verwaltung' || scene.char === 'claudia' || scene.char === 'viola') emoji = 'üë©‚Äçüíº';
                if (scene.char === 'horst' || scene.char === 'sebastian') emoji = 'üë∑‚Äç‚ôÇÔ∏è';
                fallbackEl.innerHTML = emoji;
            }
        }
        
        if (scene.char === 'klara') {
            bgContainer.classList.add('klara-mode');
            nameBadge.classList.add('klara-mode');
        } else {
            bgContainer.classList.remove('klara-mode');
            nameBadge.classList.remove('klara-mode');
        }

        document.getElementById('char-name').innerText = scene.charName || "";
        document.getElementById('scene-title').innerHTML = scene.title || "";
        document.getElementById('scene-text').innerHTML = scene.text || "";

        const actionsDiv = document.getElementById('actions');
        actionsDiv.innerHTML = "";

        const charExtraDiv = document.getElementById('char-extra');
        charExtraDiv.innerHTML = ""; 
        charExtraDiv.style.display = "none";
        charExtraDiv.style.background = "rgba(0,0,0,0.4)";
        charExtraDiv.style.border = "1px solid #555";
        charExtraDiv.style.padding = "20px";
        charExtraDiv.style.backdropFilter = "blur(5px)";

        const nameInputGroup = document.getElementById('name-input-group');
        if (sceneKey === 'intro') {
            nameInputGroup.style.display = 'block';
            if (scene.leftContent) {
                charExtraDiv.style.display = "block";
                charExtraDiv.style.background = "transparent";
                charExtraDiv.style.border = "none";
                charExtraDiv.style.padding = "0";
                charExtraDiv.style.backdropFilter = "none";
                charExtraDiv.innerHTML = scene.leftContent;
            }
        } else {
            nameInputGroup.style.display = 'none';
            if (CHAR_DESCRIPTIONS[scene.char]) {
                 charExtraDiv.style.display = "flex"; 
                 charExtraDiv.innerHTML = `<div class="role-text">${CHAR_DESCRIPTIONS[scene.char]}</div>`;
            }
        }

        if ((state.time <= 0 || state.mood <= 0 || state.budget <= 0) && sceneKey !== 'game_over_fail') { renderScene('game_over_fail'); return; }

        if (scene.special === 'ai_question') {
            openAiOverlay(scene.aiId, scene.next);
        } else if (scene.special === 'quiz') {
            openQuizOverlay(scene.quizId, scene.next);
        } else if (scene.special === 'crossword') {
            openCrosswordOverlay(scene.next, scene.cwId);
        } else if (scene.special === 'calc_score') {
            // Wait for user interaction
        } else if (scene.options && scene.options.length === 0 && sceneKey !== 'intro' && sceneKey !== 'giveup_4_fired') { 
            let btn = document.createElement('button');
            btn.className = 'choice-btn'; btn.innerHTML = "<strong>üîÑ Neu starten</strong>";
            btn.onclick = () => safeReload(); actionsDiv.appendChild(btn);
        } else {
            scene.options.forEach(opt => {
                let btn = document.createElement('button');
                btn.className = 'choice-btn';
                if(opt.specialClass) btn.classList.add(opt.specialClass);
                let costs = [];
                if(opt.costTime) costs.push(`‚è≥ -${opt.costTime}`);
                if(opt.costBudget) costs.push(`üí∞ -${opt.costBudget}`);
                btn.innerHTML = `<strong>${opt.text}</strong>` + (costs.length > 0 ? `<span class="cost-hint">${costs.join(', ')}</span>` : '');
                
                if(opt.specialExec) btn.onclick = () => window[opt.specialExec]();
                else btn.onclick = () => makeDecision(opt);
                
                actionsDiv.appendChild(btn);
            });
        }
        updateKPIs(); updateUndoBtn();
    }

    function startGame() { makeDecision({next:'start'}); }

    function makeDecision(option) {
        historyStack.push(JSON.parse(JSON.stringify(state)));
        if(option.costTime) state.time -= option.costTime;
        if(option.costBudget) state.budget -= option.costBudget;
        if(option.costMood) state.mood -= option.costMood; 
        const nextScene = scenes[option.next];
        if(nextScene && nextScene.moodChange) state.mood += nextScene.moodChange;
        renderScene(option.next);
    }

    function undoMove() {
        if (historyStack.length === 0) return;
        state = historyStack.pop();
        renderScene(state.currentScene);
    }
    function updateUndoBtn() { document.getElementById('undo-btn').disabled = historyStack.length === 0; }
    function updateKPIs() { setBar('bar-time', state.time); setBar('bar-budget', state.budget); setBar('bar-mood', state.mood); }
    function setBar(id, val) {
        val = Math.max(0, Math.min(100, val));
        const el = document.getElementById(id); el.style.width = val + '%';
        if(val < 30) el.style.background = '#e84545'; else if(val < 60) el.style.background = '#f1c40f'; else el.style.background = '#2ecc71';
    }

    // --- LOGIK F√úR AUFGEBEN (ESKALATION) ---
    function giveUp() {
        document.getElementById('overlay-ai').classList.add('hidden');
        document.getElementById('overlay-quiz').classList.add('hidden');
        document.getElementById('overlay-crossword').classList.add('hidden');
        
        state.giveUpCount = (state.giveUpCount || 0) + 1;
        
        resumeSceneAfterIntervention = nextSceneStored; 
        
        if (state.giveUpCount === 1) {
            renderScene('giveup_1_talk');
        } else if (state.giveUpCount === 2) {
            renderScene('giveup_2_warning');
        } else if (state.giveUpCount === 3) {
            renderScene('giveup_3_written');
        } else {
            renderScene('giveup_4_fired');
        }
    }

    function resumeIntervention() {
        if (resumeSceneAfterIntervention && scenes[resumeSceneAfterIntervention]) {
            renderScene(resumeSceneAfterIntervention);
        } else {
            renderScene('intro'); 
        }
    }

    // --- DEBUG SKIP ---
    function debugSkip() {
        document.getElementById('overlay-ai').classList.add('hidden');
        document.getElementById('overlay-quiz').classList.add('hidden');
        document.getElementById('overlay-crossword').classList.add('hidden');
        if(nextSceneStored) renderScene(nextSceneStored);
        else renderScene('intro'); 
    }

  // --- NEUE DYNAMISCHE KREUZWORTR√ÑTSEL LOGIK ---
    
    // Standard-Daten (Fallback), falls im Admin-Tool noch nichts gespeichert wurde
    let crosswordData = {
    "default_cw": {
        "words": [
            {
                "word": "MENTORING",
                "clu": "Langfristiger Berater (8 B.)",
                "x": 0,
                "y": 0,
                "dir": "h"
            },
            {
                "word": "COACHING",
                "clu": "Prozessbegleitung (8 B.)",
                "x": 5,
                "y": 0,
                "dir": "v"
            },
            {
                "word": "ZIELE",
                "clu": "Angestrebtes Ergebnis (5 B.)",
                "x": 4,
                "y": 4,
                "dir": "h"
            }
        ]
    },
    "crossword_scene_cw_config": {
        "words": [
            {
                "word": "MENTORING",
                "clu": "Begleitung nach dem Onboarding",
                "x": 3,
                "y": 6,
                "dir": "h"
            },
            {
                "word": "COACHING",
                "clu": "Hilfe zur Selbsthilfe",
                "x": 5,
                "y": 0,
                "dir": "v"
            },
            {
                "word": "ZIEL",
                "clu": "Angestrebtes Ergebnis ",
                "x": 9,
                "y": 5,
                "dir": "v"
            },
            {
                "word": "AZUBI",
                "clu": "Kurzwort f√ºr Auszubildende",
                "x": 5,
                "y": 2,
                "dir": "h"
            },
            {
                "word": "BETRIEBSRAT",
                "clu": "Mitarbeitervertretung",
                "x": 0,
                "y": 0,
                "dir": "v"
            },
            {
                "word": "KOTTER",
                "clu": "Erfinder des 8-Stufenmodells",
                "x": 7,
                "y": 5,
                "dir": "v"
            },
            {
                "word": "IHK",
                "clu": "Zust√§ndige Stelle",
                "x": 4,
                "y": 4,
                "dir": "h"
            },
            {
                "word": "BBIG",
                "clu": "Abk. Berufsbildungsgesetz",
                "x": 9,
                "y": 0,
                "dir": "v"
            },
            {
                "word": "AUSBILDER",
                "clu": "m√§nnlicher Lernprozessbegleiter f√ºr Azubis",
                "x": 0,
                "y": 9,
                "dir": "h"
            },
            {
                "word": "ATS",
                "clu": "Software zur Bewerberauswahl",
                "x": 2,
                "y": 7,
                "dir": "v"
            },
            {
                "word": "BILDUNG",
                "clu": "",
                "x": 11,
                "y": 0,
                "dir": "v"
            },
            {
                "word": "ROI",
                "clu": "Return of Investment",
                "x": 0,
                "y": 3,
                "dir": "h"
            },
            {
                "word": "KMK",
                "clu": "Abk√ºrzung f√ºr das Zusammetntreffen der Kultusminister",
                "x": 9,
                "y": 10,
                "dir": "h"
            },
            {
                "word": "BORIS",
                "clu": "Toller Dozent aus Leipzig",
                "x": 2,
                "y": 0,
                "dir": "v"
            },
            {
                "word": "LAM",
                "clu": "Abk√ºrzung Lern- und Arbeitsmethodik",
                "x": 9,
                "y": 8,
                "dir": "h"
            },
            {
                "word": "EGO",
                "clu": "Selbstbild, das eine Person von sich hat",
                "x": 0,
                "y": 1,
                "dir": "h"
            },
            {
                "word": "ICON",
                "clu": "Grafisches Symbol auf  einem Computermonitor",
                "x": 4,
                "y": 0,
                "dir": "h"
            },
            {
                "word": "KI",
                "clu": "Abk√ºrzung K√ºnstliche Intelligenz",
                "x": 4,
                "y": 8,
                "dir": "v"
            }
        ]
    }
};
    let currentCwId = null;

    function openCrosswordOverlay(next, cwId = 'default_cw') {
        nextSceneStored = next;
        currentCwId = cwId;
        const data = crosswordData[cwId] || crosswordData['default_cw'];
        
        const container = document.getElementById('crossword-container');
        container.innerHTML = "";
        
        // Grid-Gr√∂√üe automatisch ermitteln
        let maxX = 0; let maxY = 0;
        data.words.forEach(w => {
            if(w.dir === 'h') { maxX = Math.max(maxX, w.x + w.word.length); maxY = Math.max(maxY, w.y + 1); }
            else { maxX = Math.max(maxX, w.x + 1); maxY = Math.max(maxY, w.y + w.word.length); }
        });
        
        // Grid aufbauen
        container.style.gridTemplateColumns = `repeat(${maxX}, 35px)`;
        
        // Zellen initialisieren (leer)
        let grid = [];
        for(let y=0; y<maxY; y++) {
            grid[y] = [];
            for(let x=0; x<maxX; x++) {
                grid[y][x] = { char: null, isInput: false };
            }
        }

        // W√∂rter ins Grid eintragen
        data.words.forEach(w => {
            for(let i=0; i<w.word.length; i++) {
                let cx = w.x + (w.dir === 'h' ? i : 0);
                let cy = w.y + (w.dir === 'v' ? i : 0);
                grid[cy][cx] = { char: w.word[i], isInput: true };
            }
        });

        // HTML generieren
        let html = "";
        for(let y=0; y<maxY; y++) {
            for(let x=0; x<maxX; x++) {
                const cell = grid[y][x];
                if(cell.isInput) {
                    html += `<input class="cw-cell" type="text" maxlength="1" data-char="${cell.char}" data-x="${x}" data-y="${y}">`;
                } else {
                    html += `<div class="cw-cell black"></div>`;
                }
            }
        }
        container.innerHTML = html;

        // Hinweise anzeigen
        const cluesBox = document.querySelector('.cw-clues');
        cluesBox.innerHTML = "";
        data.words.forEach((w, index) => {
            let label = (w.dir === 'h') ? "Waagerecht" : "Senkrecht";
            cluesBox.innerHTML += `<div>${index+1}. ${label}: ${w.clu}</div>`;
        });

        document.getElementById('overlay-crossword').classList.remove('hidden');
        document.getElementById('btn-cw-success').classList.add('hidden');
        document.getElementById('cw-feedback').innerText = "";
    }

    function checkCrossword() {
        const inputs = document.querySelectorAll('#crossword-container input');
        let allCorrect = true;
        inputs.forEach(input => {
            if (!input.value || input.value.toUpperCase() !== input.dataset.char) {
                input.style.backgroundColor = "#e74c3c";
                allCorrect = false;
            } else {
                input.style.backgroundColor = "#2ecc71";
            }
        });
        
        if(allCorrect) {
            document.getElementById('cw-feedback').innerText = "Perfekt gel√∂st!";
            document.getElementById('cw-feedback').style.color = "#2ecc71";
            document.getElementById('btn-cw-success').classList.remove('hidden');
            
            // PUNKTE
            state.time += 5; state.budget += 5; state.mood += 5;
            updateKPIs();
        } else {
            document.getElementById('cw-feedback').innerText = "Da stimmt was nicht.";
            document.getElementById('cw-feedback').style.color = "#e74c3c";
        }
    }

    // NEUE FUNKTION: L√ñSUNG ANZEIGEN
    function solveCrossword() {
        const inputs = document.querySelectorAll('#crossword-container input');
        inputs.forEach(input => {
            input.value = input.dataset.char;
        });
        // Sofort pr√ºfen lassen, damit es gr√ºn wird und der Weiter-Button kommt
        checkCrossword();
    }
    
    function closeCrosswordOverlay() {
        document.getElementById('overlay-crossword').classList.add('hidden');
        renderScene(nextSceneStored);
    }

    // --- KI & QUIZ LOGIK ---
    let nextSceneStored = '';
    
    function openAiOverlay(aiId, next) {
        currentAiId = aiId;
        nextSceneStored = next;
        const scenario = aiScenarios[aiId];
        
        document.getElementById('ai-topic').innerHTML = scenario.title;
        document.getElementById('ai-intro').innerHTML = scenario.intro ? scenario.intro : "";
        document.getElementById('ai-input').value = "";
        document.getElementById('ai-result-box').style.display = 'none';
        
        document.getElementById('btn-ai-continue').classList.add('hidden');
        document.getElementById('btn-ai-retry').classList.add('hidden');
        document.getElementById('btn-ai-skip').classList.add('hidden');
        document.getElementById('btn-ai-print').classList.add('hidden');
        
        document.getElementById('overlay-ai').classList.remove('hidden');
    }

    async function analyzeAIAnswer() {
        const userText = document.getElementById('ai-input').value; 
        const scenario = aiScenarios[currentAiId]; 
        
        const feedbackBox = document.getElementById('ai-result-box');
        feedbackBox.style.display = 'block';
        document.getElementById('ai-feedback-text').innerHTML = "<i>Dr. Klara Kompetenz pr√ºft Ihre Ausarbeitung...</i> ‚è≥";
        document.getElementById('ai-verdict').innerText = "";
        document.getElementById('ai-score-fill').style.width = "0%";

        try {
            const apiUrl = "/api/chat"; // Vercel API
            const response = await fetch(apiUrl, { 
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ 
                    messages: [
                        { role: "user", content: userText } 
                    ] 
                })
            });

            if (!response.ok) throw new Error("Verbindungsfehler");
            const data = await response.text(); 
            
            let score = 0;
            const scoreMatch = data.match(/PUNKTE:\s*(\d+)/i);
            if (scoreMatch && scoreMatch[1]) score = parseInt(scoreMatch[1]); else score = 50; 
            const cleanText = data.replace(/PUNKTE:\s*\d+(\/100)?/i, "").trim();

            displayAiResult(score, cleanText);

        } catch (error) {
            console.error(error);
            document.getElementById('ai-feedback-text').innerHTML = 
                `<span style="color:#e74c3c"><b>Fehler bei der KI-Verbindung:</b><br>${error.message}<br><br>
                Die lokale Bewertung wird als Fallback genutzt.</span><hr>` + 
                analyzeAIAnswerLocal(true); 
        }
    }

    function analyzeAIAnswerLocal(returnTextOnly = false) {
        const userText = document.getElementById('ai-input').value.toLowerCase();
        const scenario = aiScenarios[currentAiId];
        let matches = 0;
        scenario.keywords.forEach(kw => { if (userText.includes(kw)) matches++; });
        let percent = Math.min(100, Math.round((matches / Math.min(4, scenario.keywords.length)) * 100));
        
        let text = (percent < 50) ? scenario.thresholds[30] : scenario.thresholds[100];
        
        if(returnTextOnly) {
            displayAiResult(percent, text + " (Offline-Bewertung)");
            return "";
        } else {
            displayAiResult(percent, text + " (Offline-Bewertung)");
        }
    }

    function displayAiResult(score, text) {
        const fill = document.getElementById('ai-score-fill');
        const verdict = document.getElementById('ai-verdict');
        const btnContinue = document.getElementById('btn-ai-continue');
        const btnRetry = document.getElementById('btn-ai-retry');
        const btnSkip = document.getElementById('btn-ai-skip');
        const btnPrint = document.getElementById('btn-ai-print');
        const scenario = aiScenarios[currentAiId];

        setTimeout(() => { fill.style.width = score + "%"; }, 100);
        
        if(!document.getElementById('ai-feedback-text').innerHTML.includes("Fehler")) {
             document.getElementById('ai-feedback-text').innerHTML = text;
        } else {
             document.getElementById('ai-feedback-text').innerHTML += "<br>" + text;
        }

        btnPrint.classList.remove('hidden');

        if (score < 50) {
            fill.style.background = "#c0392b"; 
            verdict.innerText = "‚ùå Nicht bestanden (" + score + "%)"; 
            verdict.style.color = "#c0392b"; 
            
            btnContinue.classList.add('hidden');
            btnRetry.classList.remove('hidden'); 
            btnSkip.classList.remove('hidden'); 
            
            document.getElementById('ai-feedback-text').innerHTML += `<br><br><b>Tipp:</b> ${scenario.solutionHint}`;
        } else {
            fill.style.background = "#2ecc71"; 
            verdict.innerText = "‚úÖ Bestanden (" + score + "%)"; 
            verdict.style.color = "#2ecc71"; 
            
            // --- ZUSATZPUNKTE VERGEBEN ---
            state.time += 5;
            state.budget += 5;
            state.mood += 5;
            updateKPIs();
            // -----------------------------

            btnContinue.classList.remove('hidden');
            btnRetry.classList.add('hidden');
            btnSkip.classList.add('hidden');
        }
    }

    function closeAiOverlay() { document.getElementById('overlay-ai').classList.add('hidden'); renderScene(nextSceneStored); }
    function resetAiInput() {
        document.getElementById('ai-input').value = "";
        document.getElementById('ai-result-box').style.display = 'none';
        document.getElementById('ai-input').focus();
    }
    function copyAiText() { const copyText = document.getElementById("ai-input"); copyText.select(); navigator.clipboard.writeText(copyText.value); alert("Text kopiert!"); }
    
    // DIE NEUE INTELLIGENTE DRUCK-FUNKTION
    function printOverlay() { 
        const textarea = document.getElementById('ai-input');
        const printDiv = document.createElement('div');
        printDiv.innerText = textarea.value;
        printDiv.className = 'ai-input-area'; 
        printDiv.style.height = 'auto'; 
        printDiv.style.overflow = 'visible';
        printDiv.style.border = '1px solid #ccc';
        printDiv.style.color = '#000';
        printDiv.style.background = '#fff';
        printDiv.id = 'temp-print-div';

        textarea.style.display = 'none';
        textarea.parentNode.insertBefore(printDiv, textarea);

        window.print();

        setTimeout(() => {
            printDiv.remove();
            textarea.style.display = 'block';
        }, 500);
    }

    function skipAiTask() {
        if(confirm("Aufgabe wirklich √ºberspringen? Das gibt leider keine Punkte f√ºr das Zertifikat.")) {
            closeAiOverlay();
        }
    }

    // --- QUIZ FUNCTIONS (Standard) ---
    function openQuizOverlay(quizId, next) {
        currentQuizId = quizId; nextSceneStored = next; currentQuiz = quizzes[quizId];
        
        document.getElementById('quiz-topic').innerHTML = currentQuiz.title; 
        document.getElementById('quiz-intro').innerHTML = currentQuiz.intro || "Bitte l√∂sen Sie die folgende Aufgabe:";
        
        document.getElementById('quiz-law-text').innerHTML = currentQuiz.law; document.getElementById('quiz-law-text').classList.remove('hidden');
        const container = document.getElementById('quiz-questions-container'); container.innerHTML = "";
        currentQuiz.questions.forEach((q, index) => {
            let html = `<div style="margin-bottom:15px; break-inside: avoid;"><strong>${index+1}. ${q.q}</strong><br>`;
            q.options.forEach(opt => { html += `<label class="quiz-option"><input type="checkbox" name="q${index}" value="${opt.val}"> ${opt.text}</label>`; });
            html += `</div>`; container.innerHTML += html;
        });
        document.getElementById('quiz-feedback').innerText = ""; document.getElementById('btn-quiz-success').classList.add('hidden');
        document.getElementById('overlay-quiz').classList.remove('hidden');
    }
    function checkQuiz() {
        let allCorrect = true;
        currentQuiz.questions.forEach((q, index) => {
            const checkboxes = document.querySelectorAll(`input[name="q${index}"]`);
            checkboxes.forEach(chk => { if (chk.checked !== (chk.value === 'true')) allCorrect = false; });
        });
        const feedback = document.getElementById('quiz-feedback');
        if(allCorrect) {
            feedback.innerText = "Korrekt."; feedback.style.color = "#2ecc71"; document.getElementById('btn-quiz-success').classList.remove('hidden');
            
            // --- ZUSATZPUNKTE VERGEBEN ---
            state.time += 5;
            state.budget += 5;
            state.mood += 5;
            updateKPIs();
            // -----------------------------

        } else {
            feedback.innerText = "Fehlerhaft."; feedback.style.color = "#e74c3c"; document.getElementById('btn-quiz-success').classList.add('hidden');
        }
    }
    
    function closeQuizOverlay() { document.getElementById('overlay-quiz').classList.add('hidden'); renderScene(nextSceneStored); }
    function safeReload() { if(confirm("Neustart?")) location.reload(); }
    function openImpressum() { document.getElementById('overlay-impressum').classList.remove('hidden'); }
    function closeImpressum() { document.getElementById('overlay-impressum').classList.add('hidden'); }
    
    // ZERTIFIKAT-LOGIK MIT ABSTUFUNGEN
    function showCertificate() { 
        const totalScore = state.budget + state.mood; 
        const playerNameInput = document.getElementById('player-name').value;
        const displayName = (playerNameInput && playerNameInput.trim() !== "") ? playerNameInput : "Teilnehmer/in";
        document.getElementById('cert-player-name').innerText = displayName;
        
        let title, text, color;

        if (totalScore >= 170) {
            title = "Exzellenz-Zertifikat (Vision√§r)";
            text = "Eine √ºberragende Leistung. Sie haben die PlanA GmbH strategisch perfektioniert!";
            color = "#9b59b6"; // Lila
        } else if (totalScore >= 140) {
            title = "Master-Zertifikat (DQR 7)";
            text = "Hervorragende strategische Leistung! Sie haben die meisten H√ºrden gemeistert.";
            color = "#2ecc71"; // Gr√ºn
        } else if (totalScore >= 100) {
            title = "Kompetenz-Zertifikat";
            text = "Solide Leistung. Sie haben das Planspiel erfolgreich abgeschlossen.";
            color = "#3498db"; // Blau
        } else {
            title = "Teilnahmebescheinigung";
            text = "Sie haben das Szenario durchlaufen. Es besteht noch Potenzial zur Optimierung.";
            color = "#e67e22"; // Orange
        }

        document.getElementById('cert-grade-title').innerText = title; 
        document.getElementById('cert-grade-title').style.color = color;
        document.getElementById('cert-grade-text').innerHTML = text; 
        document.getElementById('overlay-cert').classList.remove('hidden'); 
    }

    renderScene('intro');
</script>
</body>
</html>
